name: Lightsail Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string
      commit_sha:
        description: 'Specific commit SHA to deploy (optional - uses latest if empty)'
        required: false
        type: string
      skip_build:
        description: 'Skip build and use existing build artifacts'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.commit_sha || inputs.branch }}
        
    - name: Setup Node.js
      if: inputs.skip_build == false
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'yarn'
        
    - name: Install dependencies
      if: inputs.skip_build == false
      run: yarn install --frozen-lockfile
      
    - name: Build Backend
      if: inputs.deploy_backend && inputs.skip_build == false
      run: |
        yarn nx build server --configuration=production
        
    - name: Build Frontend
      if: inputs.deploy_frontend && inputs.skip_build == false
      run: |
        yarn nx build webApp --configuration=production
        
    - name: Check for existing build artifacts in git
      if: inputs.skip_build == true
      run: |
        echo "Checking for committed build artifacts..."
        echo "Commit SHA: ${{ inputs.commit_sha || github.sha }}"
        echo "Branch: ${{ inputs.branch }}"
        
        if [ "${{ inputs.deploy_backend }}" == "true" ] && [ ! -f "server/dist/main.js" ]; then
          echo "âŒ Backend build not found in this commit."
          echo "ðŸ’¡ Either:"
          echo "   1. Build and commit: yarn nx build server --configuration=production && git add . && git commit"
          echo "   2. Or set 'skip_build' to false to build during deployment"
          exit 1
        fi
        
        if [ "${{ inputs.deploy_frontend }}" == "true" ] && [ ! -f "apps/webApp/dist/index.html" ]; then
          echo "âŒ Frontend build not found in this commit."
          echo "ðŸ’¡ Either:"
          echo "   1. Build and commit: yarn nx build webApp --configuration=production && git add . && git commit"  
          echo "   2. Or set 'skip_build' to false to build during deployment"
          exit 1
        fi
        
        echo "âœ… Build artifacts found in git commit"
        ls -la server/dist/ || echo "Backend dist contents not available"
        ls -la apps/webApp/dist/ || echo "Frontend dist contents not available"
        
    - name: Create deployment package
      run: |
        mkdir -p deployment
        
        # Copy backend files
        if [ "${{ inputs.deploy_backend }}" == "true" ]; then
          cp -r server/dist deployment/server
          cp server/package.json deployment/server-package.json
          cp package.json deployment/
          cp -r libs/database/src/lib/prisma deployment/
        fi
        
        # Copy frontend files
        if [ "${{ inputs.deploy_frontend }}" == "true" ]; then
          mkdir -p deployment/frontend
          cp -r apps/webApp/dist/* deployment/frontend/
        fi
        
        # Copy deployment scripts and ecosystem config
        cp scripts/deploy/* deployment/ 2>/dev/null || true
        
        # Create deployment info
        echo "DEPLOYMENT_DATE=$(date)" > deployment/deployment-info.txt
        echo "COMMIT_SHA=${{ github.sha }}" >> deployment/deployment-info.txt
        echo "BRANCH=${{ inputs.branch }}" >> deployment/deployment-info.txt
        echo "ENVIRONMENT=${{ inputs.environment }}" >> deployment/deployment-info.txt
        
    - name: Archive deployment package
      run: |
        tar -czf gt-automotive-deployment-${{ github.sha }}.tar.gz -C deployment .
        
    - name: Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1  # Default region for S3 operations
        
    - name: Upload to S3
      run: |
        aws s3 cp gt-automotive-deployment-${{ github.sha }}.tar.gz \
          s3://${{ secrets.DEPLOYMENT_BUCKET }}/ --region us-east-1
        
    - name: Setup SSH key
      run: |
        echo "${{ secrets.LIGHTSAIL_SSH_KEY }}" > /tmp/lightsail-key.pem
        chmod 600 /tmp/lightsail-key.pem
        
    - name: Verify Lightsail Configuration
      run: |
        echo "Checking Lightsail configuration..."
        echo "Instance Name: ${{ secrets.LIGHTSAIL_INSTANCE_NAME }}"
        echo "Lightsail Region: ${{ secrets.LIGHTSAIL_REGION }}"
        echo "S3 Region: us-east-1"
        
        # List all instances in the region to help debug
        echo "Available instances in Lightsail region:"
        aws lightsail get-instances --region ${{ secrets.LIGHTSAIL_REGION }} --query 'instances[].name' --output text || echo "Failed to list instances"
        
    - name: Deploy to Lightsail
      run: |
        # Create deployment script
        cat > deploy-script.sh << 'EOF'
        #!/bin/bash
        set -e
        
        DEPLOYMENT_FILE="gt-automotive-deployment-${{ github.sha }}.tar.gz"
        DEPLOYMENT_DIR="/home/ubuntu/gt-automotive-deployment"
        APP_DIR="/home/ubuntu/GT-Automotives-App"
        
        echo "ðŸš€ Starting deployment..."
        
        # Deployment package is already copied to /tmp via SCP
        cd /tmp
        
        # Check if deployment file exists
        if [ ! -f "$DEPLOYMENT_FILE" ]; then
            echo "âŒ Deployment file not found: $DEPLOYMENT_FILE"
            exit 1
        fi
        
        echo "ðŸ“¦ Found deployment package: $DEPLOYMENT_FILE"
        
        # Create deployment directory
        rm -rf $DEPLOYMENT_DIR
        mkdir -p $DEPLOYMENT_DIR
        
        # Extract deployment package
        tar -xzf $DEPLOYMENT_FILE -C $DEPLOYMENT_DIR
        
        # Stop services gracefully
        echo "â¹ï¸ Stopping services..."
        pm2 list | grep "gt-automotive-backend" && pm2 stop gt-automotive-backend || echo "Backend not running"
        pm2 list | grep "gt-automotive-frontend" && pm2 stop gt-automotive-frontend || echo "Frontend not running"
        
        # Backup current deployment
        if [ -d "$APP_DIR" ]; then
          echo "ðŸ“¦ Creating backup..."
          cp -r $APP_DIR $APP_DIR.backup.$(date +%Y%m%d_%H%M%S)
          # Keep only last 3 backups
          ls -dt $APP_DIR.backup.* | tail -n +4 | xargs rm -rf
        fi
        
        # Deploy backend
        if [ "${{ inputs.deploy_backend }}" == "true" ]; then
          echo "ðŸ”§ Deploying backend..."
          mkdir -p $APP_DIR/server
          cp -r $DEPLOYMENT_DIR/server/* $APP_DIR/server/ 2>/dev/null || true
          cp $DEPLOYMENT_DIR/server-package.json $APP_DIR/server/package.json 2>/dev/null || true
          cp -r $DEPLOYMENT_DIR/prisma $APP_DIR/server/ 2>/dev/null || true
          
          # Install production dependencies
          cd $APP_DIR/server
          npm install --only=production
          
          # Run database migrations
          export PATH=/usr/bin:/usr/local/bin:$PATH
          npx prisma generate --schema=./prisma/schema.prisma
          npx prisma migrate deploy --schema=./prisma/schema.prisma
        fi
        
        # Deploy frontend
        if [ "${{ inputs.deploy_frontend }}" == "true" ]; then
          echo "ðŸŽ¨ Deploying frontend..."
          mkdir -p $APP_DIR/frontend
          cp -r $DEPLOYMENT_DIR/frontend/* $APP_DIR/frontend/
        fi
        
        # Copy deployment info and ecosystem config
        cp $DEPLOYMENT_DIR/deployment-info.txt $APP_DIR/
        cp $DEPLOYMENT_DIR/ecosystem.config.js $APP_DIR/ 2>/dev/null || echo "âš ï¸ ecosystem.config.js not found in deployment package"
        
        # Ensure ecosystem config exists
        if [ ! -f "$APP_DIR/ecosystem.config.js" ]; then
          echo "âŒ ecosystem.config.js not found. Creating default..."
          cat > $APP_DIR/ecosystem.config.js << 'ECOEOF'
module.exports = {
  apps: [
    {
      name: 'gt-automotive-backend',
      script: 'server/dist/main.js',
      cwd: '/home/ubuntu/GT-Automotives-App',
      instances: 1,
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000
      },
      error_file: '/home/ubuntu/logs/backend-err.log',
      out_file: '/home/ubuntu/logs/backend-out.log',
      log_file: '/home/ubuntu/logs/backend-combined.log',
      time: true
    },
    {
      name: 'gt-automotive-frontend',
      script: 'serve',
      args: '-s frontend -l 4200 -C',
      cwd: '/home/ubuntu/GT-Automotives-App',
      instances: 1,
      exec_mode: 'fork',
      env: {
        NODE_ENV: 'production'
      },
      error_file: '/home/ubuntu/logs/frontend-err.log',
      out_file: '/home/ubuntu/logs/frontend-out.log',
      log_file: '/home/ubuntu/logs/frontend-combined.log',
      time: true
    }
  ]
};
ECOEOF
        fi
        
        # Create logs directory
        mkdir -p /home/ubuntu/logs
        
        # Start services
        echo "â–¶ï¸ Starting services..."
        cd $APP_DIR
        if [ "${{ inputs.deploy_backend }}" == "true" ]; then
          pm2 start ecosystem.config.js --only gt-automotive-backend --update-env || pm2 reload gt-automotive-backend
        fi
        if [ "${{ inputs.deploy_frontend }}" == "true" ]; then
          pm2 start ecosystem.config.js --only gt-automotive-frontend --update-env || pm2 reload gt-automotive-frontend
        fi
        
        # Health check
        echo "ðŸ¥ Running health check..."
        sleep 10
        
        if [ "${{ inputs.deploy_backend }}" == "true" ]; then
          curl -f http://localhost:3000/api/health || (echo "âŒ Backend health check failed" && exit 1)
        fi
        
        if [ "${{ inputs.deploy_frontend }}" == "true" ]; then
          curl -f http://localhost:4200 || (echo "âŒ Frontend health check failed" && exit 1)
        fi
        
        echo "âœ… Deployment completed successfully!"
        echo "ðŸ“Š Deployment info:"
        cat $APP_DIR/deployment-info.txt
        
        # Cleanup
        rm -rf $DEPLOYMENT_DIR
        rm /tmp/$DEPLOYMENT_FILE
        EOF
        
        # Make script executable
        chmod +x deploy-script.sh
        
        # Check if instance is running
        INSTANCE_STATE=$(aws lightsail get-instance-state \
          --instance-name ${{ secrets.LIGHTSAIL_INSTANCE_NAME }} \
          --region ${{ secrets.LIGHTSAIL_REGION }} \
          --query 'state.name' \
          --output text)
        
        if [ "$INSTANCE_STATE" != "running" ]; then
          echo "Starting Lightsail instance..."
          aws lightsail start-instance \
            --instance-name ${{ secrets.LIGHTSAIL_INSTANCE_NAME }} \
            --region ${{ secrets.LIGHTSAIL_REGION }}
          
          # Wait for instance to be running
          echo "Waiting for instance to start..."
          sleep 30
        fi
        
        # Copy deployment package and script to instance
        echo "Copying deployment files to instance..."
        scp -o StrictHostKeyChecking=no \
          -i /tmp/lightsail-key.pem \
          gt-automotive-deployment-${{ github.sha }}.tar.gz ubuntu@${{ secrets.LIGHTSAIL_IP }}:/tmp/
        
        scp -o StrictHostKeyChecking=no \
          -i /tmp/lightsail-key.pem \
          deploy-script.sh ubuntu@${{ secrets.LIGHTSAIL_IP }}:/tmp/
          
        # Execute deployment script
        ssh -o StrictHostKeyChecking=no \
          -i /tmp/lightsail-key.pem \
          ubuntu@${{ secrets.LIGHTSAIL_IP }} \
          'chmod +x /tmp/deploy-script.sh && sudo /tmp/deploy-script.sh'
        
    - name: Notify deployment status
      if: always()
      run: |
        echo "âœ… Deployment completed!"
        echo "Status: ${{ job.status }}"
        
    - name: Create deployment summary
      if: always()
      run: |
        cat >> $GITHUB_STEP_SUMMARY << 'EOF'
        ## ðŸš€ Deployment Summary
        
        **Environment:** ${{ inputs.environment }}
        **Branch:** ${{ inputs.branch }}
        **Commit:** ${{ github.sha }}
        **Date:** $(date)
        **Triggered by:** @${{ github.actor }}
        EOF