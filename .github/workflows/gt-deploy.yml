name: GT-Automotive-Deploy
on:
  workflow_dispatch:
    inputs:
      buildNumber:
        type: string
        description: Build# (GT-Automotive-Build Run Number, e.g., 1, 2, 3)
        required: true
      target:
        type: choice
        description: Target Environment
        required: true
        default: 'production'
        options:
          - 'production'
          - 'staging'
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: true
        type: boolean

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/gt-backend
  RESOURCE_GROUP: gt-automotives-prod
  FRONTEND_APP_NAME: gt-automotives-frontend
  BACKEND_APP_NAME: gt-automotives-backend-api
  DISABLE_ERD: true
  PUPPETEER_SKIP_CHROMIUM_DOWNLOAD: true

jobs:
  Deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.target }}
    env:
      TARGET: ${{ github.event.inputs.target }}
      BUILD_NUMBER: ${{ github.event.inputs.buildNumber }}

    steps:
      - uses: AutoModality/action-clean@v1

      - uses: actions/checkout@v4

      - name: Download Build Artifacts
        uses: dawidd6/action-download-artifact@v9
        with:
          workflow: gt-build.yml
          run_number: ${{ github.event.inputs.buildNumber }}
          workflow_conclusion: success
          if_no_artifact_found: fail
          path: ./artifacts

      - name: Extract Build Information
        run: |
          echo "ğŸ“‹ Extracting build information..."

          # Find and source build information from any build-info artifact
          BUILD_INFO_FILE=$(find ./artifacts -name "build-info.txt" -type f | head -1)

          if [ -f "$BUILD_INFO_FILE" ]; then
            source "$BUILD_INFO_FILE"
            echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
            echo "BUILD_TAG=${BUILD_TAG}" >> $GITHUB_ENV
            echo "ğŸ³ Docker Image: ${IMAGE_TAG}"
          else
            echo "âŒ Build information not found!"
            exit 1
          fi

      - name: Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Backend Deployment (Web App with Docker container)
      - name: Deploy Backend to Web App
        if: github.event.inputs.deploy_backend == 'true'
        run: |
          echo "ğŸš€ Deploying backend to Azure Web App with pre-built image from GitHub Container Registry..."
          echo "ğŸ³ Using Docker image: ${{ env.IMAGE_TAG }}"

          # Update Web App to use new container image from GHCR
          az webapp config container set \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.IMAGE_TAG }} \
            --docker-registry-server-url https://${{ env.REGISTRY }} \
            --docker-registry-server-user ${{ github.actor }} \
            --docker-registry-server-password ${{ secrets.GITHUB_TOKEN }}

          # Update environment variables
          az webapp config appsettings set \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --settings \
              DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              CLERK_SECRET_KEY="${{ secrets.CLERK_SECRET_KEY }}" \
              CLERK_API_URL="${{ secrets.CLERK_API_URL }}" \
              CLERK_PUBLISHABLE_KEY="${{ secrets.CLERK_PUBLISHABLE_KEY }}" \
              CLERK_JWKS_URL="${{ secrets.CLERK_JWKS_URL }}" \
              FRONTEND_URL="${{ secrets.FRONTEND_URL }}" \
              INTERNAL_API_KEY="${{ secrets.INTERNAL_API_KEY }}" \
              AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              AZURE_STORAGE_ACCOUNT_NAME="${{ secrets.AZURE_STORAGE_ACCOUNT_NAME }}" \
              TELNYX_API_KEY="${{ secrets.TELNYX_API_KEY }}" \
              TELNYX_PUBLIC_KEY="${{ secrets.TELNYX_PUBLIC_KEY }}" \
              TELNYX_PHONE_NUMBER="${{ secrets.TELNYX_PHONE_NUMBER }}" \
              TELNYX_MESSAGING_PROFILE_ID="${{ secrets.TELNYX_MESSAGING_PROFILE_ID }}" \
              SMS_ENABLED="${{ secrets.SMS_ENABLED }}" \
              EMAIL_ENABLED="${{ secrets.EMAIL_ENABLED }}" \
              BREVO_API_KEY="${{ secrets.BREVO_API_KEY }}" \
              BREVO_SENDER_EMAIL="${{ secrets.BREVO_SENDER_EMAIL }}" \
              BREVO_SENDER_NAME="${{ secrets.BREVO_SENDER_NAME }}" \
              HOST="0.0.0.0" \
              PORT="8080" \
              NODE_ENV="production" \
              WEBSITES_PORT="8080"

          # Restart the Web App to pull new image
          echo "ğŸ”„ Restarting backend Web App..."
          az webapp restart \
            --name ${{ env.BACKEND_APP_NAME }} \
            --resource-group ${{ env.RESOURCE_GROUP }}

          echo "âœ… Backend Web App deployment completed"

      # Setup Node.js for migrations
      - name: Setup Node.js for Migrations
        if: github.event.inputs.run_migrations == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Database Migrations (optimized with pre-installed Node.js)
      - name: Run Database Migrations
        if: github.event.inputs.run_migrations == 'true'
        run: |
          echo "ğŸ—„ï¸ Running database migrations from downloaded source..."

          # Find the repository artifact directory
          REPO_ARTIFACT=$(find ./artifacts -type d -name "repo-*" | head -1)

          if [ -z "$REPO_ARTIFACT" ]; then
            echo "âŒ Repository artifact not found, skipping migrations"
            exit 0
          fi

          echo "ğŸ“¦ Found repository artifact: $REPO_ARTIFACT"
          cd "$REPO_ARTIFACT"

          # Install only what's needed for migrations
          echo "ğŸ“¦ Installing Prisma CLI..."
          npm install -g prisma@latest

          # Create .prisma directory structure to prevent ENOENT error during generate
          mkdir -p node_modules/.prisma/client/runtime

          # Install @prisma/client with proper directory setup
          npm install @prisma/client@latest --save

          # Set database URL
          export DATABASE_URL="${{ secrets.DATABASE_URL }}"
          SCHEMA_PATH="libs/database/src/lib/prisma/schema.prisma"

          if [ -f "$SCHEMA_PATH" ]; then
            echo "ğŸ“‹ Found Prisma schema, running migrations..."

            # Generate Prisma client (skip generate if it fails - migrate deploy doesn't need it)
            echo "ğŸ”§ Generating Prisma client..."
            npx prisma generate --schema="$SCHEMA_PATH" || echo "âš ï¸ Prisma generate failed, continuing with migrate deploy..."

            # Run migrations (migrate deploy doesn't need generated client)
            echo "ğŸš€ Running database migrations..."
            if npx prisma migrate deploy --schema="$SCHEMA_PATH"; then
              echo "âœ… Migrations completed successfully"
            else
              echo "âŒ Migration failed, but continuing with deployment..."
              echo "âš ï¸ Check database connectivity and migration files"
            fi
          else
            echo "âš ï¸ No Prisma schema found at $SCHEMA_PATH, skipping migrations"
          fi

          cd ../..

      # Frontend Deployment
      - name: Deploy Frontend
        if: github.event.inputs.deploy_frontend == 'true'
        run: |
          echo "ğŸŒ Deploying frontend from pre-built artifact..."

          # Find the frontend artifact directory (not the repo artifact)
          FRONTEND_ARTIFACT_DIR=$(find ./artifacts -type d -name "frontend-build-*" | head -1)

          if [ -z "$FRONTEND_ARTIFACT_DIR" ]; then
            echo "âŒ Frontend artifact directory not found!"
            exit 1
          fi

          # Find the zip file in the frontend artifact directory
          FRONTEND_ZIP=$(find "$FRONTEND_ARTIFACT_DIR" -name "frontend-*.zip" -type f | head -1)

          if [ -z "$FRONTEND_ZIP" ]; then
            echo "âŒ Frontend artifact ZIP file not found!"
            echo "Searched in: $FRONTEND_ARTIFACT_DIR"
            ls -la "$FRONTEND_ARTIFACT_DIR"
            exit 1
          fi

          echo "ğŸ“¦ Found frontend artifact: $FRONTEND_ZIP"

          # Deploy to Azure App Service using pre-built artifact
          az webapp deploy \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.FRONTEND_APP_NAME }} \
            --src-path "$FRONTEND_ZIP" \
            --type zip

          echo "âœ… Frontend deployment completed"

      - name: Restart Frontend Service
        if: github.event.inputs.deploy_frontend == 'true'
        run: |
          echo "ğŸ”„ Restarting frontend App Service..."
          az webapp restart \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --name ${{ env.FRONTEND_APP_NAME }}
          echo "âœ… Frontend restarted successfully"

      - name: Verify Deployments
        run: |
          echo "ğŸ” Verifying deployments..."

          # Wait for services to be ready
          sleep 30

          # Test backend if deployed
          if [ "${{ github.event.inputs.deploy_backend }}" = "true" ]; then
            echo "ğŸ” Testing backend Web App..."
            BACKEND_URL="https://gt-automotives-backend-api.azurewebsites.net"

            for i in {1..10}; do
              echo "ğŸ“Š Backend health check attempt $i..."

              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BACKEND_URL/health" || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Backend is responding (HTTP 200, attempt $i)"
                break
              else
                echo "â³ Backend not ready (HTTP $HTTP_CODE), waiting... (attempt $i/10)"
                if [ $i -eq 5 ]; then
                  echo "ğŸ” Mid-deployment Web App status:"
                  az webapp show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.BACKEND_APP_NAME }} --query "state" --output tsv || echo "Could not retrieve status"
                fi
                sleep 20
              fi
            done
          fi

          # Test frontend if deployed
          if [ "${{ github.event.inputs.deploy_frontend }}" = "true" ]; then
            echo "ğŸ” Testing frontend..."
            FRONTEND_URL="https://gt-automotives.com"

            for i in {1..5}; do
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL/health" || echo "000")
              if [ "$HTTP_CODE" = "200" ]; then
                echo "âœ… Frontend is responding (HTTP 200, attempt $i)"
                break
              else
                echo "â³ Frontend not ready (HTTP $HTTP_CODE), waiting... (attempt $i/5)"
                sleep 15
              fi
            done
          fi

      - name: Create Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Number:** \`${{ env.BUILD_NUMBER }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target Environment:** \`${{ env.TARGET }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** \`${{ env.IMAGE_TAG }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Pattern:** Artifact-based Web App deployment" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Component status
          if [ "${{ github.event.inputs.deploy_backend }}" = "true" ]; then
            echo "âœ… **Backend:** Deployed to Azure Web App (B1)" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ³ **Backend URL:** https://gt-automotives-backend-api.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Backend:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.deploy_frontend }}" = "true" ]; then
            echo "âœ… **Frontend:** Deployed to Azure Web App (B1)" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Frontend:** Skipped" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ github.event.inputs.run_migrations }}" = "true" ]; then
            echo "âœ… **Database:** Migrations executed from source" >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ **Database:** Migrations skipped" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸŒ Production URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://gt-automotives.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend API:** https://gt-automotives-backend-api.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Health:** https://gt-automotives-backend-api.azurewebsites.net/health" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ’° Cost Optimization" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Using GitHub Container Registry (FREE, was \$5-7/mo for ACR)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Migrated from Container Instance (\$73/mo) to Web App B1 (\$13/mo)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Total monthly cost: ~\$42-47 (down from \$109-129)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **62% total cost reduction**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Deployment Optimizations" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No rebuild during deployment (uses pre-built artifacts)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Artifact-based deployment pattern" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Pre-built Docker images from build phase" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Fast Web App container updates" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Completed
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ—ï¸ Build: ${{ env.BUILD_NUMBER }}"
          echo "ğŸ³ Docker Image: ${{ env.IMAGE_TAG }}"
          echo "ğŸŒ Frontend: https://gt-automotives.com"
          echo "ğŸ”§ Backend: https://gt-automotives-backend-api.azurewebsites.net"
          echo "âš¡ Deployed using artifact-based pattern"
          echo "ğŸ’° Cost-optimized Web App B1 deployment"