name: Add Lovepreet User to Production

on:
  workflow_dispatch:  # Manual trigger

jobs:
  add-user:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          npm install @prisma/client
          npx prisma generate --schema=libs/database/src/lib/prisma/schema.prisma
          
      - name: Add user to database
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          cat > add-user.js << 'SCRIPT'
          const { PrismaClient } = require('@prisma/client');
          const prisma = new PrismaClient();
          
          async function main() {
            try {
              // Check if user exists
              const existing = await prisma.user.findUnique({
                where: { clerkId: 'user_32vzzkxNNoQOZ7W8h0FXtVJD17T' }
              });
          
              if (existing) {
                console.log('âœ… User already exists:', existing.email);
                return;
              }
          
              // Get or create STAFF role
              let role = await prisma.role.findUnique({
                where: { name: 'STAFF' }
              });
          
              if (!role) {
                role = await prisma.role.create({
                  data: { 
                    name: 'STAFF', 
                    description: 'Staff member with operational access' 
                  }
                });
                console.log('Created STAFF role');
              }
          
              // Create user
              const user = await prisma.user.create({
                data: {
                  clerkId: 'user_32vzzkxNNoQOZ7W8h0FXtVJD17T',
                  email: 'brarlovepreet7310@gmail.com',
                  firstName: 'Lovepreet',
                  lastName: 'Singh',
                  roleId: role.id,
                  isActive: true
                }
              });
          
              console.log('âœ… Successfully created user:');
              console.log('   Name:', user.firstName, user.lastName);
              console.log('   Email:', user.email);
              console.log('   Clerk ID:', user.clerkId);
            } catch (error) {
              console.error('âŒ Error:', error.message);
              process.exit(1);
            } finally {
              await prisma.$disconnect();
            }
          }
          
          main();
          SCRIPT
          
          node add-user.js
