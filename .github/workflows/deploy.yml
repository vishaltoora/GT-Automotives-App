name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number to deploy (e.g., build-20241212-143052-abc1234)'
        required: true
        type: string
      deploy_frontend:
        description: 'Deploy Frontend'
        required: true
        default: true
        type: boolean
      deploy_backend:
        description: 'Deploy Backend'
        required: true
        default: true
        type: boolean
      deployment_type:
        description: 'Backend deployment type (container recommended - has architectural fixes)'
        required: true
        default: 'container'
        type: choice
        options:
        - 'container'
        - 'app-service'
      run_migrations:
        description: 'Run database migrations'
        required: true
        default: true
        type: boolean

env:
  RESOURCE_GROUP: gt-automotives-prod
  FRONTEND_APP_NAME: gt-automotives-frontend
  BACKEND_APP_NAME: gt-automotives-backend
  REGISTRY_NAME: gtautomotivesregistry
  CONTAINER_NAME: gt-backend-working

jobs:
  validate-build:
    runs-on: ubuntu-latest
    outputs:
      build-number: ${{ steps.validate.outputs.build-number }}
      frontend-artifact: ${{ steps.validate.outputs.frontend-artifact }}
      backend-artifact: ${{ steps.validate.outputs.backend-artifact }}
      build-valid: ${{ steps.validate.outputs.build-valid }}
    
    steps:
    - name: Validate build number format
      id: validate
      run: |
        BUILD_NUMBER="${{ github.event.inputs.build_number }}"
        
        # Validate format: build-YYYYMMDD-HHMMSS-shortsha
        if [[ $BUILD_NUMBER =~ ^build-[0-9]{8}-[0-9]{6}-[a-f0-9]{7}$ ]]; then
          echo "âœ… Build number format is valid: $BUILD_NUMBER"
          echo "build-valid=true" >> $GITHUB_OUTPUT
          echo "build-number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "frontend-artifact=frontend-$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "backend-artifact=backend-$BUILD_NUMBER" >> $GITHUB_OUTPUT
        else
          echo "âŒ Invalid build number format: $BUILD_NUMBER"
          echo "Expected format: build-YYYYMMDD-HHMMSS-shortsha"
          echo "Example: build-20241212-143052-abc1234"
          echo "build-valid=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Check artifact availability
      run: |
        echo "ğŸ” Checking if artifacts exist for build: ${{ github.event.inputs.build_number }}"
        echo "Will look for:"
        echo "- Frontend: ${{ steps.validate.outputs.frontend-artifact }}"
        echo "- Backend: ${{ steps.validate.outputs.backend-artifact }}"

  deploy-backend:
    runs-on: ubuntu-latest
    needs: validate-build
    if: github.event.inputs.deploy_backend == 'true' && github.event.inputs.deployment_type == 'app-service'
    
    steps:
    - name: Download backend artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build.yml
        workflow_conclusion: success
        name: ${{ needs.validate-build.outputs.backend-artifact }}
        path: ./backend-deploy

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Run database migrations
      if: github.event.inputs.run_migrations == 'true'
      run: |
        echo "ğŸ—„ï¸ Running database migrations..."
        
        # Extract and prepare migration files
        cd backend-deploy
        unzip -q ${{ needs.validate-build.outputs.backend-artifact }}.zip
        
        # Install Prisma CLI temporarily
        npm install -g prisma
        
        # Run migrations
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        
        if [ -f "prisma/schema.prisma" ]; then
          echo "ğŸ“‹ Found Prisma schema, running migrations..."
          prisma migrate deploy --schema=prisma/schema.prisma
          echo "âœ… Migrations completed successfully"
        else
          echo "âš ï¸ No Prisma schema found, skipping migrations"
        fi
        
        cd ..

    - name: Configure App Service settings
      run: |
        echo "âš™ï¸ Configuring App Service settings..."
        
        # Configure Node.js runtime and startup
        az webapp config appsettings set \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }} \
          --settings \
            WEBSITE_NODE_DEFAULT_VERSION="~20" \
            SCM_DO_BUILD_DURING_DEPLOYMENT="false" \
            WEBSITE_RUN_FROM_PACKAGE="1" \
            WEBSITES_CONTAINER_START_TIME_LIMIT="1800"
        
        # Set startup command
        az webapp config set \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }} \
          --startup-file "node main.js"

    - name: Deploy backend to App Service
      run: |
        echo "ğŸš€ Deploying backend build: ${{ github.event.inputs.build_number }}"
        
        cd backend-deploy
        
        # Deploy to Azure App Service
        az webapp deploy \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }} \
          --src-path ${{ needs.validate-build.outputs.backend-artifact }}.zip \
          --type zip
        
        echo "âœ… Backend deployment completed"

    - name: Restart backend App Service
      run: |
        echo "ğŸ”„ Restarting backend App Service..."
        az webapp restart \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.BACKEND_APP_NAME }}
        
        echo "âœ… Backend restarted successfully"

    - name: Verify backend deployment
      run: |
        echo "ğŸ” Verifying backend deployment..."
        
        # Wait for restart to complete
        sleep 30
        
        # Test health endpoint
        BACKEND_URL="https://${{ env.BACKEND_APP_NAME }}.azurewebsites.net"
        
        echo "Testing: $BACKEND_URL/health"
        
        for i in {1..5}; do
          if curl -f -s "$BACKEND_URL/health" > /dev/null; then
            echo "âœ… Backend is responding (attempt $i)"
            break
          else
            echo "â³ Backend not ready, waiting... (attempt $i/5)"
            sleep 15
          fi
        done

  deploy-backend-container:
    runs-on: ubuntu-latest
    needs: validate-build
    if: github.event.inputs.deploy_backend == 'true' && github.event.inputs.deployment_type == 'container'
    
    steps:
    - name: Download backend artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build.yml
        workflow_conclusion: success
        name: ${{ needs.validate-build.outputs.backend-artifact }}
        path: ./backend-deploy

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Login to Azure Container Registry
      run: |
        echo "ğŸ” Logging in to Azure Container Registry..."
        az acr login --name ${{ env.REGISTRY_NAME }}

    - name: Extract and prepare deployment files
      run: |
        echo "ğŸ“¦ Extracting deployment package with container fixes..."
        cd backend-deploy
        unzip -q ${{ needs.validate-build.outputs.backend-artifact }}.zip
        
        echo "ğŸ“‹ Deployment structure:"
        ls -la
        
        echo "ğŸ” Verifying webpack externals and shared library structure:"
        ls -la node_modules/@gt-automotive/ || echo "Shared libraries not found - checking server build"
        ls -la server/ || echo "Server files not found"

    - name: Create optimized Dockerfile with fixes
      run: |
        echo "ğŸ³ Creating Dockerfile with container deployment fixes..."
        cd backend-deploy
        
        cat > Dockerfile << 'EOF'
        FROM node:20-slim

        WORKDIR /app

        # Install system dependencies for Prisma
        RUN apt-get update && apt-get install -y openssl && rm -rf /var/lib/apt/lists/*

        # Copy deployment package (already contains Prisma client from build process)
        COPY . ./

        # Install only production dependencies (Prisma client already generated in build)
        RUN npm install --production --no-package-lock

        # Verify deployment structure and dependencies with error checking
        RUN echo "ğŸ“‹ Verifying deployment structure:" && \
            ls -la && \
            echo "ğŸ” Checking server files:" && \
            ls -la server/ && \
            if [ ! -f "server/main.js" ]; then echo "âŒ ERROR: server/main.js not found!"; exit 1; fi && \
            echo "ğŸ” Checking Prisma:" && \
            ls -la prisma/ && \
            if [ ! -f "prisma/schema.prisma" ]; then echo "âŒ ERROR: prisma/schema.prisma not found!"; exit 1; fi && \
            echo "ğŸ” Checking node_modules structure:" && \
            ls -la node_modules/@gt-automotive/ && \
            echo "âœ… Container deployment structure verified"

        # Add a simple health check script for debugging
        RUN echo '#!/bin/bash\necho "Starting GT Automotive Backend..."\necho "Node version: $(node --version)"\necho "Available files:"\nls -la\necho "Starting application..."\nexec node server/main.js' > /app/start.sh && \
            chmod +x /app/start.sh

        # Create non-root user for security
        RUN groupadd -r nodejs && useradd -r -g nodejs nodejs && \
            chown -R nodejs:nodejs /app
        USER nodejs

        EXPOSE 3000

        # Use the debug startup script for better error visibility
        CMD ["/app/start.sh"]
        EOF

    - name: Build and push Docker image
      run: |
        echo "ğŸ”¨ Building Docker image with container fixes..."
        cd backend-deploy
        
        IMAGE_TAG="container-deploy-${{ needs.validate-build.outputs.build-number }}"
        FULL_IMAGE_NAME="${{ env.REGISTRY_NAME }}.azurecr.io/gt-backend:$IMAGE_TAG"
        
        echo "ğŸ·ï¸ Building image: $FULL_IMAGE_NAME"
        echo "ğŸ“‹ Build number from input: ${{ needs.validate-build.outputs.build-number }}"
        echo "ğŸ“‹ Complete tag: $IMAGE_TAG"
        
        # Build with no cache to ensure fresh build
        docker build -t "$FULL_IMAGE_NAME" . --no-cache
        
        echo "ğŸš€ Pushing image to registry..."
        docker push "$FULL_IMAGE_NAME"
        
        echo "IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

    - name: Run database migrations
      if: github.event.inputs.run_migrations == 'true'
      run: |
        echo "ğŸ—„ï¸ Running database migrations directly on runner..."
        
        # Clean and extract deployment package to get Prisma schema
        cd backend-deploy
        rm -f build-info.json || true  # Remove any existing build-info.json
        unzip -o -q ${{ needs.validate-build.outputs.backend-artifact }}.zip
        
        # Install Prisma CLI and client dependencies on the runner
        npm install -g prisma@latest
        npm install @prisma/client@latest
        
        # Run migrations directly with proper error handling
        export DATABASE_URL="${{ secrets.DATABASE_URL }}"
        
        if [ -f "prisma/schema.prisma" ]; then
          echo "ğŸ“‹ Found Prisma schema, running migrations..."
          
          # Create a minimal package.json for proper Prisma client generation
          cat > package.json << 'EOF'
        {
          "name": "migration-temp",
          "version": "1.0.0",
          "dependencies": {
            "@prisma/client": "latest",
            "prisma": "latest"
          }
        }
        EOF
          
          # Install dependencies locally for proper Prisma client generation
          npm install --no-package-lock
          
          # Generate Prisma client with proper binary resolution
          echo "ğŸ”§ Generating Prisma client for migrations..."
          npx prisma generate --schema=prisma/schema.prisma
          
          # Run migrations
          echo "ğŸš€ Running database migrations..."
          if npx prisma migrate deploy --schema=prisma/schema.prisma; then
            echo "âœ… Migrations completed successfully"
          else
            echo "âŒ Migration failed, but continuing with deployment..."
            echo "âš ï¸ You may need to run migrations manually after deployment"
            echo "ğŸ’¡ Check database connectivity and migration files"
            
            # Show more detailed error information
            echo "ğŸ” Database URL format check:"
            echo "Database URL starts with: ${DATABASE_URL:0:20}..."
            echo "ğŸ” Prisma client status:"
            ls -la node_modules/@prisma/client/ 2>/dev/null || echo "Prisma client not found"
          fi
        else
          echo "âš ï¸ No Prisma schema found, skipping migrations"
        fi
        
        cd ..

    - name: Deploy to Azure Container Instances
      run: |
        echo "ğŸš€ Deploying to Azure Container Instances with fixes..."
        
        # Delete existing container if it exists
        az container delete \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --yes || echo "No existing container to delete"
        
        # Create new container instance
        az container create \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CONTAINER_NAME }} \
          --image ${{ env.IMAGE_NAME }} \
          --os-type Linux \
          --dns-name-label gt-automotives-backend-working \
          --ports 3000 \
          --cpu 2 \
          --memory 4 \
          --registry-login-server ${{ env.REGISTRY_NAME }}.azurecr.io \
          --registry-username ${{ env.REGISTRY_NAME }} \
          --registry-password $(az acr credential show --name ${{ env.REGISTRY_NAME }} --query "passwords[0].value" --output tsv) \
          --environment-variables \
            DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            CLERK_SECRET_KEY="${{ secrets.CLERK_SECRET_KEY }}" \
            PORT="3000" \
            NODE_ENV="production"
        
        echo "âœ… Container deployment completed"

    - name: Verify container deployment
      run: |
        echo "ğŸ” Verifying container deployment..."
        
        # Check container status before testing
        echo "ğŸ” Checking container status..."
        az container show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME }} --query "{state: instanceView.state, restartCount: instanceView.restartCount, events: instanceView.events}" --output table || true
        
        # Wait for container to start
        sleep 60
        
        CONTAINER_URL="http://gt-automotives-backend-working.canadacentral.azurecontainer.io:3000"
        
        echo "Testing: $CONTAINER_URL/health"
        
        for i in {1..10}; do
          # Check container status on each attempt
          echo "ğŸ“Š Container status (attempt $i):"
          az container show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME }} --query "instanceView.state" --output tsv || echo "Status check failed"
          
          if curl -f -s "$CONTAINER_URL/health" > /dev/null; then
            echo "âœ… Container backend is responding (attempt $i)"
            
            # Test a few endpoints to verify full functionality
            echo "ğŸ§ª Testing detailed health endpoint..."
            curl -s "$CONTAINER_URL/health/detailed" | head -10 || echo "Detailed health test failed"
            
            break
          else
            echo "â³ Container not ready, waiting... (attempt $i/10)"
            
            # Show container logs if it's failing
            if [ $i -eq 5 ]; then
              echo "ğŸ” Mid-deployment container logs:"
              az container logs --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME }} || echo "Could not retrieve logs"
            fi
            
            sleep 30
          fi
        done
        
        # Always check container logs for debugging
        echo "ğŸ“‹ Final container logs:"
        az container logs --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME }} || echo "Could not retrieve container logs"
        
        # Show container events for debugging
        echo "ğŸ“‹ Container events:"
        az container show --resource-group ${{ env.RESOURCE_GROUP }} --name ${{ env.CONTAINER_NAME }} --query "instanceView.events[*].[message,timeStamp]" --output table || echo "Could not retrieve container events"

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [validate-build, deploy-backend, deploy-backend-container]
    if: always() && github.event.inputs.deploy_frontend == 'true' && (needs.deploy-backend.result == 'success' || needs.deploy-backend.result == 'skipped' || needs.deploy-backend-container.result == 'success' || needs.deploy-backend-container.result == 'skipped')
    
    steps:
    - name: Download frontend artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        workflow: build.yml
        workflow_conclusion: success
        name: ${{ needs.validate-build.outputs.frontend-artifact }}
        path: ./frontend-deploy

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Deploy frontend to App Service
      run: |
        echo "ğŸŒ Deploying frontend build: ${{ github.event.inputs.build_number }}"
        
        cd frontend-deploy
        
        # Deploy to Azure App Service
        az webapp deploy \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.FRONTEND_APP_NAME }} \
          --src-path ${{ needs.validate-build.outputs.frontend-artifact }}.zip \
          --type zip
        
        echo "âœ… Frontend deployment completed"

    - name: Restart frontend App Service
      run: |
        echo "ğŸ”„ Restarting frontend App Service..."
        az webapp restart \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.FRONTEND_APP_NAME }}
        
        echo "âœ… Frontend restarted successfully"

    - name: Verify frontend deployment
      run: |
        echo "ğŸ” Verifying frontend deployment..."
        
        # Wait for restart to complete
        sleep 30
        
        # Test main site
        FRONTEND_URL="https://gt-automotives.com"
        
        echo "Testing: $FRONTEND_URL/health"
        
        for i in {1..5}; do
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FRONTEND_URL/health" || echo "000")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Frontend is responding (attempt $i)"
            break
          else
            echo "â³ Frontend not ready (HTTP $HTTP_CODE), waiting... (attempt $i/5)"
            sleep 15
          fi
        done

  deployment-summary:
    runs-on: ubuntu-latest
    needs: [validate-build, deploy-backend, deploy-backend-container, deploy-frontend]
    if: always()
    
    steps:
    - name: Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Number:** \`${{ github.event.inputs.build_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Backend status (App Service vs Container)
        if [ "${{ github.event.inputs.deploy_backend }}" = "true" ]; then
          if [ "${{ github.event.inputs.deployment_type }}" = "container" ]; then
            if [ "${{ needs.deploy-backend-container.result }}" = "success" ]; then
              echo "âœ… **Backend (Container):** Deployed successfully to Azure Container Instances" >> $GITHUB_STEP_SUMMARY
              echo "ğŸ³ **Container URL:** http://gt-automotives-backend-working.canadacentral.azurecontainer.io:3000" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Backend (Container):** Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            if [ "${{ needs.deploy-backend.result }}" = "success" ]; then
              echo "âœ… **Backend (App Service):** Deployed successfully to Azure App Service" >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Backend (App Service):** Deployment failed" >> $GITHUB_STEP_SUMMARY
            fi
          fi
        else
          echo "â­ï¸ **Backend:** Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Frontend status
        if [ "${{ github.event.inputs.deploy_frontend }}" = "true" ]; then
          if [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
            echo "âœ… **Frontend:** Deployed successfully" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Frontend:** Deployment failed" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "â­ï¸ **Frontend:** Skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Migration status
        if [ "${{ github.event.inputs.run_migrations }}" = "true" ]; then
          echo "âœ… **Database:** Migrations executed" >> $GITHUB_STEP_SUMMARY
        else
          echo "â­ï¸ **Database:** Migrations skipped" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸŒ Production URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend:** https://gt-automotives.com" >> $GITHUB_STEP_SUMMARY
        if [ "${{ github.event.inputs.deployment_type }}" = "container" ]; then
          echo "- **Backend (Container):** http://gt-automotives-backend-working.canadacentral.azurecontainer.io:3000" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Health:** http://gt-automotives-backend-working.canadacentral.azurecontainer.io:3000/health" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Backend (App Service):** https://gt-automotives-backend.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend Health:** https://gt-automotives-backend.azurewebsites.net/health" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Notify deployment completion
      run: |
        # Check which backend deployment was used
        BACKEND_SUCCESS="false"
        if [ "${{ github.event.inputs.deployment_type }}" = "container" ]; then
          if [ "${{ needs.deploy-backend-container.result }}" = "success" ]; then
            BACKEND_SUCCESS="true"
          fi
        else
          if [ "${{ needs.deploy-backend.result }}" = "success" ]; then
            BACKEND_SUCCESS="true"
          fi
        fi
        
        if [ "$BACKEND_SUCCESS" = "true" ] && [ "${{ needs.deploy-frontend.result }}" = "success" ]; then
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸŒ Site: https://gt-automotives.com"
          echo "ğŸ—ï¸ Build: ${{ github.event.inputs.build_number }}"
          if [ "${{ github.event.inputs.deployment_type }}" = "container" ]; then
            echo "ğŸ³ Backend: Container deployment with architectural fixes"
            echo "ğŸ“¡ Container URL: http://gt-automotives-backend-working.canadacentral.azurecontainer.io:3000"
          else
            echo "ğŸ–¥ï¸ Backend: App Service deployment"
          fi
        else
          echo "âš ï¸ Deployment completed with some issues"
          echo "Check the logs above for details"
        fi