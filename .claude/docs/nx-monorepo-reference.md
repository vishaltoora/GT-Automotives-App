# Nx Monorepo Reference Guide

## Overview

Nx is a powerful monorepo framework that enables efficient development, building, and deployment of multiple interconnected applications and libraries. This guide covers GT Automotive's specific Nx configuration and best practices.

## Project Structure

```
gt-automotives-app/
├── apps/
│   └── webApp/                 # React frontend application
├── server/                     # NestJS backend application
├── libs/
│   ├── database/              # Prisma database library
│   └── shared-dto/            # Shared data transfer objects
├── dist/                      # Build output directory
│   ├── apps/webApp/          # Frontend build output
│   ├── server/               # Backend webpack build output
│   └── libs/                 # Library build outputs
├── node_modules/
├── package.json              # Root package.json with workspace scripts
├── nx.json                   # Nx workspace configuration
└── tsconfig.base.json        # Shared TypeScript configuration
```

## Key Concepts

### 1. Build Outputs and Paths

**Frontend (React/Vite)**
- **Source**: `apps/webApp/`
- **Build Command**: `yarn build:web` or `nx build webApp`
- **Output**: `apps/webApp/dist/` (Vite default) → copied to `dist/apps/webApp/`
- **Entry Point**: `apps/webApp/dist/index.html`

**Backend (NestJS/Webpack)**
- **Source**: `server/src/main.ts`
- **Build Command**: `yarn build:server` or `nx build server`
- **Webpack Config**: `server/webpack.config.js`
- **Output Path**: `dist/server/` (configured in webpack.config.js)
- **Main File**: `dist/server/main.js`
- **Package.json**: `dist/server/package.json` (auto-generated by Nx)

**Libraries**
- **Database**: `libs/database/` → `dist/libs/database/`
- **Shared DTO**: `libs/shared-dto/` → `dist/libs/shared-dto/`

### 2. Build Targets and Commands

```bash
# Individual project builds
yarn build:web          # Frontend only (nx build webApp)
yarn build:server       # Backend only (nx build server)

# Library builds
yarn nx build database      # Build database library
yarn nx build shared-dto    # Build shared DTO library

# Complete builds
yarn build              # All projects (nx run-many --target=build --all)
yarn typecheck          # All projects type checking
yarn lint              # All projects linting
```

### 3. Webpack Configuration (Backend)

```javascript
// server/webpack.config.js
const { NxAppWebpackPlugin } = require('@nx/webpack/app-plugin');
const { join } = require('path');

module.exports = {
  output: {
    path: join(__dirname, '../dist/server'), // Output to project root dist/server/
  },
  plugins: [
    new NxAppWebpackPlugin({
      target: 'node',           // Node.js backend
      compiler: 'tsc',          # TypeScript compilation
      main: './src/main.ts',    # Entry point
      outputHashing: 'none',    # No hash in filenames
      generatePackageJson: true, # Auto-generate package.json
    }),
  ],
};
```

### 4. External Dependencies (Critical for Containers)

Webpack externalizes certain dependencies to avoid bundling issues:

```javascript
// Externalized dependencies (not bundled):
- @prisma/client          # Prisma requires native binaries
- .prisma/client          # Generated Prisma client
- @gt-automotive/shared-dto  # Shared library (resolved via node_modules)
```

## Common Build Issues and Solutions

### Issue 1: "Cannot find module @gt-automotive/shared-dto"

**Cause**: Shared library not built or not properly linked in node_modules

**Solution**:
```bash
# Always build shared libraries first
yarn nx build shared-dto
yarn build:server
```

### Issue 2: "main.js not found" in deployment

**Paths to Check**:
- ✅ **Correct**: `dist/server/main.js` (webpack output)
- ❌ **Wrong**: `server/dist/main.js` (this contains only .d.ts files)

**Verification**:
```bash
# Check actual webpack output
ls -la dist/server/main.js

# TypeScript definitions are separate
ls -la server/dist/main.d.ts
```

### Issue 3: Prisma Client Issues in Containers

**Problem**: Prisma client needs proper binary compilation for container environment

**Solution**:
```dockerfile
# Install Prisma CLI and generate client in container
RUN npm install prisma@latest && \
    npx prisma generate --schema=./prisma/schema.prisma
```

### Issue 4: Shared Library Resolution in Containers

**Problem**: Webpack externalizes shared libraries but they're not available in container

**Solution**: Manual node_modules structure creation:
```bash
# Create proper node_modules structure
mkdir -p ./node_modules/@gt-automotive/shared-dto/dist/
cp -r ./shared-dto-temp/* ./node_modules/@gt-automotive/shared-dto/dist/
cp ./shared-dto-package.json ./node_modules/@gt-automotive/shared-dto/package.json
```

## Development Workflow

### 1. Starting Development

```bash
# Install dependencies
yarn install --frozen-lockfile --ignore-engines

# Generate Prisma client
yarn prisma generate --schema=libs/database/src/lib/prisma/schema.prisma

# Start development servers
yarn dev                    # Both frontend and backend
# OR separately:
yarn dev:web               # Frontend only (port 4200)
yarn dev:server            # Backend only (port 3000)
```

### 2. Making Changes

**Frontend Changes**:
- Edit files in `apps/webApp/src/`
- Hot reload available in development
- Build with `yarn build:web`

**Backend Changes**:
- Edit files in `server/src/`
- Restart required in development
- Build with `yarn build:server`

**Shared Library Changes**:
- Edit files in `libs/shared-dto/src/`
- Must rebuild library: `yarn nx build shared-dto`
- Then rebuild consuming projects

### 3. Building for Production

```bash
# Clean build
yarn nx reset               # Clear Nx cache
yarn build                 # Build all projects
```

## Container Deployment Patterns

### 1. Multi-Stage Dockerfile (Not Recommended for GT Automotive)

Issues with shared libraries and Prisma client generation.

### 2. Single-Stage with Pre-Built Artifacts (Recommended)

```dockerfile
FROM node:20-slim
WORKDIR /app

# Copy deployment package (already built externally)
COPY . ./

# Install runtime dependencies and generate Prisma client
RUN npm install --production && \
    npx prisma generate --schema=./prisma/schema.prisma

# Create proper node_modules structure for externalized dependencies
RUN mkdir -p ./node_modules/@gt-automotive/shared-dto/dist/ && \
    cp -r ./shared-dto-temp/* ./node_modules/@gt-automotive/shared-dto/dist/

CMD ["node", "server/main.js"]
```

### 3. Deployment Package Structure

```
backend-deploy/
├── server/                 # Webpack build output
│   ├── main.js            # Main application file
│   ├── package.json       # Auto-generated dependencies
│   └── ...                # Other webpack outputs
├── prisma/                # Database schema and migrations
│   ├── schema.prisma
│   └── migrations/
├── shared-dto-temp/       # Temporary shared library files
├── package.json           # Production dependencies
└── Dockerfile             # Container definition
```

## Nx Commands Reference

### Project Management
```bash
# List all projects
nx show projects

# Show project details
nx show project server
nx show project webApp

# Project dependencies
nx graph                   # Visual dependency graph
```

### Building and Testing
```bash
# Build specific project
nx build server
nx build webApp
nx build shared-dto

# Build with specific configuration
nx build server --configuration=production

# Run tests
nx test server
nx test webApp

# Lint projects
nx lint server
nx lint webApp
```

### Cache Management
```bash
# Clear all caches
nx reset

# Show cache status
nx show cache
```

### Advanced Commands
```bash
# Build all affected projects (based on git changes)
nx affected:build

# Run multiple targets
nx run-many --target=build --projects=server,webApp

# Run all builds in parallel
nx run-many --target=build --all --parallel
```

## Troubleshooting

### Build Cache Issues

**Symptoms**: Builds using outdated files, changes not reflected

**Solution**:
```bash
nx reset                   # Clear Nx cache
rm -rf dist/              # Clear build outputs
yarn build                # Clean rebuild
```

### TypeScript Path Mapping Issues

**Problem**: Import paths not resolving correctly

**Check**: `tsconfig.base.json` paths configuration:
```json
{
  "compilerOptions": {
    "paths": {
      "@gt-automotive/shared-dto": ["libs/shared-dto/src/index.ts"],
      "@gt-automotive/database": ["libs/database/src/index.ts"]
    }
  }
}
```

### Webpack Externals Not Working

**Symptoms**: Large bundle sizes, Prisma/shared-dto bundled incorrectly

**Verify**: Check webpack.config.js externals configuration and that dependencies are properly externalized.

## Best Practices

### 1. Build Order Dependencies
Always build in dependency order:
1. `shared-dto` (no dependencies)
2. `database` (may depend on shared-dto)
3. `server` (depends on both)
4. `webApp` (depends on shared-dto)

### 2. Container Deployment
- Use single-stage Dockerfile with pre-built artifacts
- Generate Prisma client in container environment
- Manually create node_modules structure for externalized dependencies

### 3. Development Efficiency
- Use `nx affected` commands when working on large changes
- Keep Nx cache enabled for faster builds
- Use `--skip-nx-cache` flag when troubleshooting cache issues

### 4. Shared Libraries
- Always version shared libraries properly
- Build shared libraries before dependent projects
- Test shared library changes across all consuming projects

## Production Checklist

- [ ] All projects build successfully (`yarn build`)
- [ ] Type checking passes (`yarn typecheck`)
- [ ] Linting passes (`yarn lint`)
- [ ] Tests pass (`yarn test`)
- [ ] Prisma client generated (`yarn prisma generate`)
- [ ] Build outputs verified at expected paths
- [ ] Container deployment tested locally
- [ ] Environment variables configured
- [ ] Database migrations applied

---

This reference guide should be updated as the Nx configuration evolves and new patterns emerge during development and deployment.