# Verified Build Paths Reference

## Overview

This document records the verified, working build paths for GT Automotive's containerized deployment, confirmed by inspecting the live Azure container and successful builds.

## Path Verification Summary

### ✅ CORRECT PATHS (Verified Working)

**Webpack Build Output (Local)**
- **Command**: `yarn build:server`
- **Output Path**: `./dist/server/main.js` (from project root)
- **Status**: ✅ Confirmed working

**GitHub Actions Build Process**
- **Copy Command**: `cp -r dist/server/* backend-deploy/server/`
- **Status**: ✅ Fixed and verified working (Build #17982101398 successful)

**Container Structure (Azure)**
- **Working Container**: `gt-automotives-backend-prod.canadacentral.azurecontainer.io`
- **File Location**: `/app/dist/server/main.js`
- **Dockerfile CMD**: `CMD ["node", "dist/server/main.js"]`
- **Status**: ✅ Confirmed working in production

### ❌ INCORRECT PATHS (Previously Causing Issues)

**Local Deploy Script Error**
- **Script**: `deploy-backend-container.sh` (line 85)
- **Wrong Command**: `cp -r server/dist/* backend-deploy/server/`
- **Issue**: `server/dist/` contains only `.d.ts` files, not `main.js`
- **Status**: ❌ This path is incorrect but script may have worked for other reasons

**Previous GitHub Workflow Error**
- **Wrong Path**: Looking for `server/dist/main.js`
- **Issue**: Webpack doesn't output to this location
- **Status**: ❌ Fixed in recent commits

## Detailed Path Analysis

### Local Build Environment

```bash
# After running: yarn build:server

# TypeScript definitions (NOT the main application)
./server/dist/
├── main.d.ts          # Type definitions only
├── main.d.ts.map      # Source maps for definitions
└── ...other .d.ts files

# Webpack JavaScript output (MAIN APPLICATION)
./dist/server/
├── main.js            # ✅ ACTUAL EXECUTABLE FILE
├── main.js.map        # Source maps
├── package.json       # Auto-generated by Nx
└── assets/            # Static assets
```

### Container Environment (Verified Live)

```bash
# Azure Container: gt-automotives-backend-prod
# Container Path: /app/

/app/
├── dist/
│   ├── libs/          # Shared libraries
│   └── server/        # ✅ SERVER APPLICATION
│       └── main.js    # ✅ EXECUTABLE FILE (188,745 bytes)
├── libs/              # Source libraries
├── node_modules/      # Runtime dependencies
└── package.json       # Container package.json
```

### Dockerfile Configuration (Verified)

```dockerfile
# Dockerfile CMD (WORKING)
CMD ["node", "dist/server/main.js"]

# This resolves to: /app/dist/server/main.js
# Which matches the actual file location ✅
```

## Build Process Flow

### 1. Local Build
```bash
yarn nx build shared-dto    # Build shared libraries first
yarn build:server          # Build server application
# Output: dist/server/main.js ✅
```

### 2. GitHub Actions (Fixed)
```bash
# Build step
yarn build:server

# Package step (CORRECT)
cp -r dist/server/* backend-deploy/server/
# Results in: backend-deploy/server/main.js ✅
```

### 3. Container Build
```dockerfile
# Copy deployment package to container
COPY . ./
# Results in: /app/server/main.js inside deployment package
# Which becomes: /app/dist/server/main.js after copy ✅
```

## Troubleshooting Guide

### Issue: "main.js not found" in GitHub Actions
**Symptoms**: `cp: cannot stat 'dist/server/*': No such file or directory`

**Root Cause**: Build and copy operations in separate workflow steps

**Solution**: Ensure build and copy happen in same workflow step:
```yaml
- name: Build and package backend
  run: |
    yarn build:server              # Build first
    cp -r dist/server/* backend-deploy/server/  # Then copy immediately
```

### Issue: Container fails to start
**Symptoms**: Container exits immediately or shows "module not found"

**Verification Steps**:
```bash
# Check if file exists in container
az container exec --resource-group RESOURCE_GROUP --name CONTAINER_NAME --exec-command "ls -la /app/dist/server/main.js"

# Check Dockerfile CMD matches file location
grep "CMD" Dockerfile
# Should show: CMD ["node", "dist/server/main.js"]
```

### Issue: Wrong file being executed
**Symptoms**: TypeScript definition errors, "unexpected token" errors

**Check**: Ensure you're not copying from TypeScript definitions:
```bash
# WRONG - Contains only .d.ts files
ls -la server/dist/

# CORRECT - Contains main.js executable
ls -la dist/server/
```

## Historical Context

### Why the Local Script Seemed to Work
The `deploy-backend-container.sh` script used the wrong path (`server/dist/*`) but may have appeared to work because:
1. The script might not have been used for the current production deployment
2. There might have been manual corrections during deployment
3. The container might have been built with different tooling

### GitHub Actions Issues
The workflow initially failed because:
1. Build and copy were in separate steps (directory didn't persist)
2. Used wrong copy path (copied from debugging confusion)
3. Lack of verification of actual webpack output location

## Best Practices

### 1. Always Verify Paths
```bash
# After any build changes, verify:
yarn build:server
ls -la dist/server/main.js  # Should exist and be ~190KB webpack bundle
```

### 2. Container Testing
```bash
# Test container locally before deployment
docker build -t test-image .
docker run --rm test-image ls -la /app/dist/server/main.js
```

### 3. Path Consistency
- **Local builds**: `dist/server/main.js`
- **Container**: `/app/dist/server/main.js`
- **Dockerfile CMD**: `dist/server/main.js`
- **GitHub Actions**: Copy from `dist/server/*`

## Verification Commands

### Local Environment
```bash
# Verify webpack output
yarn build:server && ls -la dist/server/main.js

# Check file is webpack bundle
head -5 dist/server/main.js  # Should show webpack bootstrap
```

### Azure Container
```bash
# List backend containers
az container list --resource-group gt-automotives-prod --query "[?contains(name, 'backend')].name" --output tsv

# Check file in container
az container exec --resource-group gt-automotives-prod --name CONTAINER_NAME --exec-command "ls -la /app/dist/server/main.js"
```

### GitHub Actions
```bash
# Check latest build
gh run list --limit 1

# Download and inspect build artifact (if needed)
gh run download RUN_ID --name backend-build-TIMESTAMP
```

---

**Last Verified**: September 24, 2025
**Container**: `gt-automotives-backend-prod.canadacentral.azurecontainer.io`
**Build**: `build-20250924-154714-411b57d` ✅ SUCCESS
**Status**: All paths verified and working correctly